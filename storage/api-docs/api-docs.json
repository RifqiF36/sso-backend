{
    "openapi": "3.0.0",
    "info": {
        "title": "SSO Mitra â€¢ Identity Provider & OAuth2 Authorization Server",
        "description": "Layanan SSO Mitra menggunakan Laravel Sanctum untuk autentikasi dan OAuth2 Authorization Code Grant untuk SSO integration dengan aplikasi klien (SIPRIMA, dsb).",
        "version": "1.0.0"
    },
    "servers": [
        {
            "url": "http://127.0.0.1:9000",
            "description": "Production SSO Mitra Server"
        }
    ],
    "paths": {
        "/api/v1/apps": {
            "get": {
                "tags": [
                    "App Picker"
                ],
                "summary": "Daftar aplikasi yang boleh diakses oleh user",
                "operationId": "SsoMitraAppPicker",
                "responses": {
                    "200": {
                        "description": "OK",
                        "content": {
                            "application/json": {
                                "schema": {},
                                "example": [
                                    {
                                        "code": "asset",
                                        "name": "Asset Management",
                                        "url": "http://127.0.0.1:8000",
                                        "icon": "https://example.com/icons/asset.png"
                                    }
                                ]
                            }
                        }
                    }
                },
                "security": [
                    {
                        "BearerAuth": []
                    }
                ]
            }
        },
        "/api/v1/auth/login": {
            "post": {
                "tags": [
                    "Auth"
                ],
                "summary": "Login user (Sanctum Token)",
                "operationId": "SsoMitraLogin",
                "requestBody": {
                    "required": true,
                    "content": {
                        "application/json": {
                            "schema": {
                                "required": [
                                    "email",
                                    "password"
                                ],
                                "properties": {
                                    "email": {
                                        "type": "string",
                                        "example": "admin_kota@sso"
                                    },
                                    "password": {
                                        "type": "string",
                                        "example": "AdminKota@123"
                                    }
                                },
                                "type": "object"
                            },
                            "example": {
                                "email": "admin_kota@sso",
                                "password": "AdminKota@123"
                            }
                        }
                    }
                },
                "responses": {
                    "200": {
                        "description": "Berhasil login",
                        "content": {
                            "application/json": {
                                "schema": {
                                    "properties": {
                                        "token": {
                                            "type": "string"
                                        },
                                        "user": {
                                            "properties": {
                                                "id": {
                                                    "type": "integer",
                                                    "example": 1
                                                },
                                                "name": {
                                                    "type": "string",
                                                    "example": "Admin Kota"
                                                },
                                                "email": {
                                                    "type": "string",
                                                    "example": "admin_kota@sso"
                                                },
                                                "roles": {
                                                    "type": "array",
                                                    "items": {
                                                        "properties": {
                                                            "role": {
                                                                "type": "string",
                                                                "example": "admin_kota"
                                                            },
                                                            "module": {
                                                                "type": "string",
                                                                "example": "asset_risk"
                                                            },
                                                            "tenant_id": {
                                                                "type": "integer",
                                                                "example": 1
                                                            },
                                                            "granted_at": {
                                                                "type": "string",
                                                                "example": "2025-11-15 00:00:00"
                                                            },
                                                            "expires_at": {
                                                                "type": "string",
                                                                "example": null
                                                            }
                                                        },
                                                        "type": "object"
                                                    }
                                                },
                                                "tenants": {
                                                    "type": "array",
                                                    "items": {
                                                        "properties": {
                                                            "tenant_id": {
                                                                "type": "integer",
                                                                "example": 1
                                                            },
                                                            "nama": {
                                                                "type": "string",
                                                                "example": "Diskominfo Kota"
                                                            },
                                                            "kode": {
                                                                "type": "string",
                                                                "example": "diskominfo"
                                                            }
                                                        },
                                                        "type": "object"
                                                    }
                                                },
                                                "apps": {
                                                    "type": "array",
                                                    "items": {
                                                        "properties": {
                                                            "code": {
                                                                "type": "string",
                                                                "example": "asset"
                                                            },
                                                            "name": {
                                                                "type": "string",
                                                                "example": "Asset Management"
                                                            },
                                                            "url": {
                                                                "type": "string",
                                                                "example": "http://127.0.0.1:8000"
                                                            }
                                                        },
                                                        "type": "object"
                                                    }
                                                }
                                            },
                                            "type": "object"
                                        }
                                    },
                                    "type": "object"
                                },
                                "example": {
                                    "token": "1|admin-kota-demo-token",
                                    "user": {
                                        "id": 1,
                                        "name": "Admin Kota",
                                        "email": "admin_kota@sso",
                                        "roles": [
                                            {
                                                "role": "admin_kota",
                                                "module": "asset_risk",
                                                "tenant_id": 1,
                                                "granted_at": "2025-11-15 00:00:00",
                                                "expires_at": null
                                            }
                                        ],
                                        "tenants": [
                                            {
                                                "tenant_id": 1,
                                                "nama": "Diskominfo Kota",
                                                "kode": "diskominfo"
                                            }
                                        ],
                                        "apps": [
                                            {
                                                "code": "asset",
                                                "name": "Asset Management",
                                                "url": "http://127.0.0.1:8000"
                                            }
                                        ]
                                    }
                                }
                            }
                        }
                    },
                    "401": {
                        "description": "Invalid credentials",
                        "content": {
                            "application/json": {
                                "schema": {},
                                "example": {
                                    "message": "Invalid credentials."
                                }
                            }
                        }
                    }
                }
            }
        },
        "/api/v1/auth/logout": {
            "post": {
                "tags": [
                    "Auth"
                ],
                "summary": "Logout dan revoke token aktif",
                "operationId": "SsoMitraLogout",
                "responses": {
                    "200": {
                        "description": "Token revoked",
                        "content": {
                            "application/json": {
                                "schema": {},
                                "example": {
                                    "message": "logged out"
                                }
                            }
                        }
                    }
                },
                "security": [
                    {
                        "BearerAuth": []
                    }
                ]
            }
        },
        "/api/v1/auth/me": {
            "get": {
                "tags": [
                    "Auth"
                ],
                "summary": "Profil user aktif + konteks",
                "operationId": "SsoMitraMe",
                "responses": {
                    "200": {
                        "description": "OK",
                        "content": {
                            "application/json": {
                                "schema": {},
                                "example": {
                                    "id": 1,
                                    "name": "Admin Kota",
                                    "email": "admin_kota@sso",
                                    "roles": [
                                        {
                                            "role": "admin_kota",
                                            "module": "asset_risk",
                                            "tenant_id": 1
                                        }
                                    ],
                                    "tenants": [
                                        {
                                            "tenant_id": 1,
                                            "nama": "Diskominfo Kota",
                                            "kode": "diskominfo"
                                        }
                                    ],
                                    "apps": [
                                        {
                                            "code": "asset",
                                            "name": "Asset Management",
                                            "url": "http://127.0.0.1:8000"
                                        }
                                    ]
                                }
                            }
                        }
                    }
                },
                "security": [
                    {
                        "BearerAuth": []
                    }
                ]
            }
        },
        "/api/v1/auth/roles": {
            "get": {
                "tags": [
                    "Auth"
                ],
                "summary": "Daftar role user",
                "operationId": "SsoMitraRoles",
                "parameters": [
                    {
                        "name": "module",
                        "in": "query",
                        "required": false,
                        "schema": {
                            "type": "string",
                            "example": "asset_risk"
                        }
                    }
                ],
                "responses": {
                    "200": {
                        "description": "OK",
                        "content": {
                            "application/json": {
                                "schema": {},
                                "example": {
                                    "roles": [
                                        {
                                            "role": "admin_kota",
                                            "module": "asset_risk",
                                            "tenant_id": 1
                                        }
                                    ]
                                }
                            }
                        }
                    }
                },
                "security": [
                    {
                        "BearerAuth": []
                    }
                ]
            }
        },
        "/api/v1/auth/refresh": {
            "post": {
                "tags": [
                    "Auth"
                ],
                "summary": "Informasi refresh token",
                "operationId": "SsoMitraRefresh",
                "responses": {
                    "200": {
                        "description": "Info",
                        "content": {
                            "application/json": {
                                "schema": {},
                                "example": {
                                    "message": "Use /auth/login to get a new token"
                                }
                            }
                        }
                    }
                },
                "security": [
                    {
                        "BearerAuth": []
                    }
                ]
            }
        },
        "/api/v1/auth/sso/authorize": {
            "get": {
                "tags": [
                    "SSO"
                ],
                "summary": "Get authorization code untuk client aplikasi (OAuth2 Authorization Code Grant)",
                "operationId": "SsoMitraSsoAuthorize",
                "parameters": [
                    {
                        "name": "client_id",
                        "in": "query",
                        "required": true,
                        "schema": {
                            "type": "string",
                            "example": "siprima-app"
                        }
                    },
                    {
                        "name": "redirect_uri",
                        "in": "query",
                        "required": true,
                        "schema": {
                            "type": "string",
                            "example": "http://127.0.0.1:8000/api/v1/auth/sso/callback"
                        }
                    },
                    {
                        "name": "state",
                        "in": "query",
                        "required": true,
                        "schema": {
                            "type": "string",
                            "example": "state-demo-123"
                        }
                    },
                    {
                        "name": "response_type",
                        "in": "query",
                        "required": false,
                        "schema": {
                            "type": "string",
                            "example": "code"
                        }
                    }
                ],
                "responses": {
                    "200": {
                        "description": "Authorization code berhasil dibuat (valid 5 menit)",
                        "content": {
                            "application/json": {
                                "schema": {},
                                "example": {
                                    "data": {
                                        "auth_code": "1e1c5e7c1c6d40b0bdb4b7f777281234",
                                        "state": "state-demo-123",
                                        "redirect_uri": "http://127.0.0.1:8000/api/v1/auth/sso/callback"
                                    }
                                }
                            }
                        }
                    },
                    "400": {
                        "description": "Invalid client_id / redirect_uri"
                    }
                },
                "security": [
                    {
                        "BearerAuth": []
                    }
                ]
            }
        },
        "/api/v1/auth/sso/token": {
            "post": {
                "tags": [
                    "SSO"
                ],
                "summary": "Tukar authorization code dengan access token (OAuth2 Token Exchange)",
                "operationId": "SsoMitraSsoToken",
                "requestBody": {
                    "required": true,
                    "content": {
                        "application/json": {
                            "schema": {
                                "required": [
                                    "code",
                                    "client_id",
                                    "client_secret",
                                    "grant_type",
                                    "redirect_uri"
                                ],
                                "properties": {
                                    "code": {
                                        "type": "string",
                                        "example": "1e1c5e7c1c6d40b0bdb4b7f777281234"
                                    },
                                    "client_id": {
                                        "type": "string",
                                        "example": "siprima-app"
                                    },
                                    "client_secret": {
                                        "type": "string",
                                        "example": "supersecret123"
                                    },
                                    "grant_type": {
                                        "type": "string",
                                        "example": "authorization_code"
                                    },
                                    "redirect_uri": {
                                        "description": "Harus sama dengan redirect URI saat authorize",
                                        "type": "string",
                                        "example": "http://127.0.0.1:8000/api/v1/auth/sso/callback"
                                    }
                                },
                                "type": "object"
                            }
                        }
                    }
                },
                "responses": {
                    "200": {
                        "description": "Access token berhasil dibuat",
                        "content": {
                            "application/json": {
                                "schema": {},
                                "example": {
                                    "data": {
                                        "access_token": "2|external-token-demo",
                                        "token_type": "Bearer",
                                        "expires_in": 7200
                                    }
                                }
                            }
                        }
                    },
                    "400": {
                        "description": "Invalid client credential"
                    },
                    "401": {
                        "description": "Authorization code tidak valid / expired"
                    }
                }
            }
        },
        "/api/v1/auth/sso/userinfo": {
            "get": {
                "tags": [
                    "SSO"
                ],
                "summary": "Dapatkan informasi user dan roles (untuk keperluan callback client)",
                "operationId": "SsoMitraSsoUserinfo",
                "responses": {
                    "200": {
                        "description": "User info berhasil diambil",
                        "content": {
                            "application/json": {
                                "schema": {},
                                "example": {
                                    "id": 1,
                                    "username": "admin_kota@sso",
                                    "email": "admin_kota@sso",
                                    "name": "Admin Kota",
                                    "roles": [
                                        "admin_kota"
                                    ]
                                }
                            }
                        }
                    },
                    "401": {
                        "description": "User belum login"
                    }
                },
                "security": [
                    {
                        "BearerAuth": []
                    }
                ]
            }
        },
        "/api/v1/auth/sso/redirect": {
            "get": {
                "tags": [
                    "SSO"
                ],
                "summary": "Dapatkan URL redirect ke IdP (legacy - untuk client lain)",
                "operationId": "SsoMitraSsoRedirect",
                "responses": {
                    "200": {
                        "description": "OK",
                        "content": {
                            "application/json": {
                                "schema": {},
                                "example": {
                                    "url": "https://idp.example.com/oauth/authorize?..."
                                }
                            }
                        }
                    }
                }
            }
        },
        "/api/v1/auth/sso/callback": {
            "get": {
                "tags": [
                    "SSO"
                ],
                "summary": "Callback dari IdP (legacy - untuk client lain)",
                "operationId": "SsoMitraSsoCallback",
                "parameters": [
                    {
                        "name": "code",
                        "in": "query",
                        "required": true,
                        "schema": {
                            "type": "string",
                            "example": "demo-code"
                        }
                    },
                    {
                        "name": "state",
                        "in": "query",
                        "required": true,
                        "schema": {
                            "type": "string",
                            "example": "demo-state"
                        }
                    }
                ],
                "responses": {
                    "200": {
                        "description": "Berhasil autentikasi",
                        "content": {
                            "application/json": {
                                "schema": {},
                                "example": {
                                    "token": "3|admin-kota-sso",
                                    "user": {
                                        "id": 1,
                                        "name": "Admin Kota",
                                        "email": "admin_kota@sso"
                                    },
                                    "provider": "default"
                                }
                            }
                        }
                    },
                    "400": {
                        "description": "State/Code invalid"
                    },
                    "401": {
                        "description": "Tidak bisa tukar authorization code"
                    }
                }
            }
        },
        "/api/v1/iam/roles": {
            "get": {
                "tags": [
                    "IAM"
                ],
                "summary": "Daftar role berdasarkan modul",
                "operationId": "SsoMitraIamRoles",
                "parameters": [
                    {
                        "name": "module",
                        "in": "query",
                        "required": false,
                        "schema": {
                            "type": "string",
                            "example": "asset_risk"
                        }
                    }
                ],
                "responses": {
                    "200": {
                        "description": "OK",
                        "content": {
                            "application/json": {
                                "schema": {},
                                "example": [
                                    {
                                        "role_id": 1,
                                        "name": "admin_kota",
                                        "module": "asset_risk",
                                        "description": "Administrator Kota"
                                    }
                                ]
                            }
                        }
                    }
                },
                "security": [
                    {
                        "BearerAuth": []
                    }
                ]
            }
        },
        "/api/v1/iam/assign-role": {
            "post": {
                "tags": [
                    "IAM"
                ],
                "summary": "Assign role ke user",
                "operationId": "SsoMitraIamAssign",
                "requestBody": {
                    "content": {
                        "application/json": {
                            "schema": {
                                "required": [
                                    "user_id",
                                    "role",
                                    "tenant_id",
                                    "module"
                                ],
                                "properties": {
                                    "user_id": {
                                        "type": "integer",
                                        "example": 1
                                    },
                                    "role": {
                                        "type": "string",
                                        "example": "admin_kota"
                                    },
                                    "tenant_id": {
                                        "type": "integer",
                                        "example": 1
                                    },
                                    "module": {
                                        "type": "string",
                                        "example": "asset_risk"
                                    }
                                },
                                "type": "object"
                            },
                            "example": {
                                "user_id": 1,
                                "role": "admin_kota",
                                "tenant_id": 1,
                                "module": "asset_risk"
                            }
                        }
                    }
                },
                "responses": {
                    "200": {
                        "description": "Role assigned",
                        "content": {
                            "application/json": {
                                "schema": {},
                                "example": {
                                    "message": "role assigned"
                                }
                            }
                        }
                    }
                },
                "security": [
                    {
                        "BearerAuth": []
                    }
                ]
            }
        },
        "/api/v1/iam/users/{id}/roles": {
            "get": {
                "tags": [
                    "IAM"
                ],
                "summary": "Daftar role user per tenant & module",
                "operationId": "SsoMitraIamUserRoles",
                "parameters": [
                    {
                        "name": "id",
                        "in": "path",
                        "required": true,
                        "schema": {
                            "type": "integer",
                            "example": 1
                        }
                    }
                ],
                "responses": {
                    "200": {
                        "description": "OK",
                        "content": {
                            "application/json": {
                                "schema": {},
                                "example": [
                                    {
                                        "role": "admin_kota",
                                        "module": "asset_risk",
                                        "tenant_id": 1,
                                        "granted_at": "2025-11-15 00:00:00"
                                    }
                                ]
                            }
                        }
                    }
                },
                "security": [
                    {
                        "BearerAuth": []
                    }
                ]
            }
        },
        "/api/v1/iam/revoke-role": {
            "post": {
                "tags": [
                    "IAM"
                ],
                "summary": "Revoke role dari user",
                "operationId": "SsoMitraIamRevoke",
                "requestBody": {
                    "content": {
                        "application/json": {
                            "schema": {
                                "required": [
                                    "user_id",
                                    "role",
                                    "tenant_id",
                                    "module"
                                ],
                                "properties": {
                                    "user_id": {
                                        "type": "integer",
                                        "example": 1
                                    },
                                    "role": {
                                        "type": "string",
                                        "example": "admin_kota"
                                    },
                                    "tenant_id": {
                                        "type": "integer",
                                        "example": 1
                                    },
                                    "module": {
                                        "type": "string",
                                        "example": "asset_risk"
                                    }
                                },
                                "type": "object"
                            },
                            "example": {
                                "user_id": 1,
                                "role": "admin_kota",
                                "tenant_id": 1,
                                "module": "asset_risk"
                            }
                        }
                    }
                },
                "responses": {
                    "200": {
                        "description": "Role revoked",
                        "content": {
                            "application/json": {
                                "schema": {},
                                "example": {
                                    "message": "role revoked"
                                }
                            }
                        }
                    }
                },
                "security": [
                    {
                        "BearerAuth": []
                    }
                ]
            }
        },
        "/api/v1/iam/audit-logs": {
            "get": {
                "tags": [
                    "IAM"
                ],
                "summary": "Audit log IAM terbaru",
                "operationId": "SsoMitraIamAuditLogs",
                "responses": {
                    "200": {
                        "description": "OK",
                        "content": {
                            "application/json": {
                                "schema": {},
                                "example": [
                                    {
                                        "action": "assign-role",
                                        "user_id": 1,
                                        "role": "admin_kota",
                                        "tenant_id": 1,
                                        "performed_by": 1,
                                        "created_at": "2025-11-15 00:00:00"
                                    }
                                ]
                            }
                        }
                    }
                },
                "security": [
                    {
                        "BearerAuth": []
                    }
                ]
            }
        },
        "/api/v1/tenants": {
            "get": {
                "tags": [
                    "Tenant"
                ],
                "summary": "Daftar tenant milik user",
                "operationId": "SsoMitraTenantList",
                "responses": {
                    "200": {
                        "description": "OK",
                        "content": {
                            "application/json": {
                                "schema": {},
                                "example": [
                                    {
                                        "tenant_id": 1,
                                        "nama": "Diskominfo Kota",
                                        "kode": "diskominfo"
                                    }
                                ]
                            }
                        }
                    }
                },
                "security": [
                    {
                        "BearerAuth": []
                    }
                ]
            }
        },
        "/api/v1/tenants/{tenant}/switch": {
            "post": {
                "tags": [
                    "Tenant"
                ],
                "summary": "Switch tenant aktif",
                "operationId": "SsoMitraTenantSwitch",
                "parameters": [
                    {
                        "name": "tenant",
                        "in": "path",
                        "required": true,
                        "schema": {
                            "type": "integer",
                            "example": 1
                        }
                    }
                ],
                "responses": {
                    "200": {
                        "description": "Tenant switched",
                        "content": {
                            "application/json": {
                                "schema": {},
                                "example": {
                                    "active_tenant": {
                                        "tenant_id": 1,
                                        "nama": "Diskominfo Kota",
                                        "kode": "diskominfo"
                                    }
                                }
                            }
                        }
                    }
                },
                "security": [
                    {
                        "BearerAuth": []
                    }
                ]
            }
        }
    },
    "components": {
        "securitySchemes": {
            "BearerAuth": {
                "type": "http",
                "description": "Bearer token dari endpoint login lokal (untuk protected endpoints yang memerlukan auth), atau access token dari OAuth2 token endpoint",
                "bearerFormat": "Sanctum",
                "scheme": "bearer"
            }
        }
    },
    "tags": [
        {
            "name": "Auth",
            "description": "Autentikasi lokal - login, logout, profil, refresh token"
        },
        {
            "name": "SSO",
            "description": "OAuth2 Authorization Code Grant Flow - authorize, token exchange, userinfo (untuk aplikasi klien seperti SIPRIMA)"
        },
        {
            "name": "Tenant",
            "description": "Manajemen tenant/OPD - daftar dan switch tenant"
        },
        {
            "name": "IAM",
            "description": "IAM/RBAC - manajemen role dan permissions"
        },
        {
            "name": "App Picker",
            "description": "Daftar aplikasi yang bisa diakses user berdasarkan role"
        }
    ]
}